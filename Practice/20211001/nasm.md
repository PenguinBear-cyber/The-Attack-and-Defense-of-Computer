# nasm

nasm負責彙編檔案，因此可以使用這個指令:
`nasm -f <format> <filename> [-o <output>]`

例如:想將檔案'file.asm'彙編成'ELF'格式的檔案'file.o'。

`nasm -f file.asm -o file.o`

首先，在kali上先安裝nasm
```
> apt-get install nasm
```
安裝完成!


### 第一部分:32位元Linux系統呼叫

首先，先編輯一份32位元的檔案
`gedit helloworld32.asm`

編輯完成後，接著執行下面指令來彙編檔案
```
> nasm -f elf32 helloworld32.asm
> ld helloworld32.o -o helloworld32
```
Output出現Error@@
```
ld: i386 architecture of input file `helloworld32.o' is incompatible with i386:x86-64 output
```
Error表示輸入檔為ELF32格式，但目前系統為64位元的，而ld預設生成的檔案格式elf64-x86-64，因此會出現這樣的錯誤提示。

由於ld不支援elf32，改用下面指令來解決錯誤，使用-m elf_i386可以模擬32位元平臺上ld的指令。
```
> ld -m elf_i386 -o helloworld32 helloworld32.o
```
解決錯誤!系統執行恢復正常!!
```
> ./helloworld32
```
即會輸出編輯檔案中撰寫的輸出`Hello World!`

接著，hexdump命令一般用來檢視"二進位制"檔案的十六進位制編碼，在程式輸出二進位制格式的檔案時，常用hexdump來檢查輸出是否正確。

因此，用hexdump來看看。
```
> hd helloworld32.o
```
Output:
```
00000000  7f 45 4c 46 01 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 03 00 01 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  40 00 00 00 00 00 00 00  34 00 00 00 00 00 28 00  |@.......4.....(.|
00000030  07 00 03 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000060  00 00 00 00 00 00 00 00  01 00 00 00 01 00 00 00  |................|
00000070  03 00 00 00 00 00 00 00  60 01 00 00 0d 00 00 00  |........`.......|
00000080  00 00 00 00 00 00 00 00  04 00 00 00 00 00 00 00  |................|
00000090  07 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  |................|
000000a0  70 01 00 00 22 00 00 00  00 00 00 00 00 00 00 00  |p..."...........|
000000b0  10 00 00 00 00 00 00 00  0d 00 00 00 03 00 00 00  |................|
000000c0  00 00 00 00 00 00 00 00  a0 01 00 00 31 00 00 00  |............1...|
000000d0  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|
000000e0  17 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
000000f0  e0 01 00 00 70 00 00 00  05 00 00 00 06 00 00 00  |....p...........|
00000100  04 00 00 00 10 00 00 00  1f 00 00 00 03 00 00 00  |................|
00000110  00 00 00 00 00 00 00 00  50 02 00 00 28 00 00 00  |........P...(...|
00000120  00 00 00 00 00 00 00 00  01 00 00 00 00 00 00 00  |................|
00000130  27 00 00 00 09 00 00 00  00 00 00 00 00 00 00 00  |'...............|
00000140  80 02 00 00 08 00 00 00  04 00 00 00 02 00 00 00  |................|
00000150  04 00 00 00 08 00 00 00  00 00 00 00 00 00 00 00  |................|
00000160  48 65 6c 6c 6f 20 77 6f  72 6c 64 21 0a 00 00 00  |Hello world!....|
00000170  b8 04 00 00 00 bb 01 00  00 00 b9 00 00 00 00 ba  |................|
00000180  0d 00 00 00 cd 80 b8 01  00 00 00 bb 00 00 00 00  |................|
00000190  cd 80 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001a0  00 2e 64 61 74 61 00 2e  74 65 78 74 00 2e 73 68  |..data..text..sh|
000001b0  73 74 72 74 61 62 00 2e  73 79 6d 74 61 62 00 2e  |strtab..symtab..|
000001c0  73 74 72 74 61 62 00 2e  72 65 6c 2e 74 65 78 74  |strtab..rel.text|
000001d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000001f0  01 00 00 00 00 00 00 00  00 00 00 00 04 00 f1 ff  |................|
00000200  00 00 00 00 00 00 00 00  00 00 00 00 03 00 01 00  |................|
00000210  00 00 00 00 00 00 00 00  00 00 00 00 03 00 02 00  |................|
00000220  12 00 00 00 00 00 00 00  00 00 00 00 00 00 01 00  |................|
00000230  18 00 00 00 0d 00 00 00  00 00 00 00 00 00 f1 ff  |................|
00000240  21 00 00 00 00 00 00 00  00 00 00 00 10 00 02 00  |!...............|
00000250  00 68 65 6c 6c 6f 77 6f  72 6c 64 33 32 2e 61 73  |.helloworld32.as|
00000260  6d 00 68 65 6c 6c 6f 00  68 65 6c 6c 6f 4c 65 6e  |m.hello.helloLen|
00000270  00 5f 73 74 61 72 74 00  00 00 00 00 00 00 00 00  |._start.........|
00000280  0b 00 00 00 01 02 00 00  00 00 00 00 00 00 00 00  |................|
00000290
```
---

### 第二部分:64位元Linux系統呼叫

步驟同上述32位元系統呼叫。

首先，先編輯一份64位元的檔案
`gedit helloworld64.asm`

編輯完成後，接著執行下面指令來彙編檔案。
```
> nasm -f elf64 helloworld64.asm
> ld helloworld64.o -o helloworld64
> ./helloworld64
```
即會輸出編輯檔案中撰寫的輸出`Hello, World!`

接著，用hexdump來看看。
```
> hd helloworld64.o
```
Output:
```
00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|
00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..>.............|
00000020  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|
00000030  00 00 00 00 40 00 00 00  00 00 40 00 07 00 03 00  |....@.....@.....|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000080  01 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  |................|
00000090  00 00 00 00 00 00 00 00  00 02 00 00 00 00 00 00  |................|
000000a0  27 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |'...............|
000000b0  10 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000c0  07 00 00 00 01 00 00 00  03 00 00 00 00 00 00 00  |................|
000000d0  00 00 00 00 00 00 00 00  30 02 00 00 00 00 00 00  |........0.......|
000000e0  0e 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000f0  04 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000100  0d 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000110  00 00 00 00 00 00 00 00  40 02 00 00 00 00 00 00  |........@.......|
00000120  32 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |2...............|
00000130  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000140  17 00 00 00 02 00 00 00  00 00 00 00 00 00 00 00  |................|
00000150  00 00 00 00 00 00 00 00  80 02 00 00 00 00 00 00  |................|
00000160  a8 00 00 00 00 00 00 00  05 00 00 00 06 00 00 00  |................|
00000170  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00000180  1f 00 00 00 03 00 00 00  00 00 00 00 00 00 00 00  |................|
00000190  00 00 00 00 00 00 00 00  30 03 00 00 00 00 00 00  |........0.......|
000001a0  28 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |(...............|
000001b0  01 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001c0  27 00 00 00 04 00 00 00  00 00 00 00 00 00 00 00  |'...............|
000001d0  00 00 00 00 00 00 00 00  60 03 00 00 00 00 00 00  |........`.......|
000001e0  18 00 00 00 00 00 00 00  04 00 00 00 01 00 00 00  |................|
000001f0  08 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00000200  b8 01 00 00 00 bf 01 00  00 00 48 be 00 00 00 00  |..........H.....|
00000210  00 00 00 00 ba 0e 00 00  00 0f 05 b8 3c 00 00 00  |............<...|
00000220  bf 00 00 00 00 0f 05 00  00 00 00 00 00 00 00 00  |................|
00000230  48 65 6c 6c 6f 2c 20 77  6f 72 6c 64 21 0a 00 00  |Hello, world!...|
00000240  00 2e 74 65 78 74 00 2e  64 61 74 61 00 2e 73 68  |..text..data..sh|
00000250  73 74 72 74 61 62 00 2e  73 79 6d 74 61 62 00 2e  |strtab..symtab..|
00000260  73 74 72 74 61 62 00 2e  72 65 6c 61 2e 74 65 78  |strtab..rela.tex|
00000270  74 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |t...............|
00000280  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000290  00 00 00 00 00 00 00 00  01 00 00 00 04 00 f1 ff  |................|
000002a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002b0  00 00 00 00 03 00 01 00  00 00 00 00 00 00 00 00  |................|
000002c0  00 00 00 00 00 00 00 00  00 00 00 00 03 00 02 00  |................|
000002d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000002e0  19 00 00 00 00 00 02 00  00 00 00 00 00 00 00 00  |................|
000002f0  00 00 00 00 00 00 00 00  21 00 00 00 00 00 f1 ff  |........!.......|
00000300  0e 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000310  12 00 00 00 10 00 01 00  00 00 00 00 00 00 00 00  |................|
00000320  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000330  00 68 65 6c 6c 6f 77 6f  72 6c 64 36 34 2e 61 73  |.helloworld64.as|
00000340  6d 00 5f 73 74 61 72 74  00 6d 65 73 73 61 67 65  |m._start.message|
00000350  00 6c 65 6e 67 74 68 00  00 00 00 00 00 00 00 00  |.length.........|
00000360  0c 00 00 00 00 00 00 00  01 00 00 00 03 00 00 00  |................|
00000370  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000380
```
---
### 第三部分:64-bit作業系統開發32-bit與64-bit的執行檔

首先，先編輯一份檔案
`gedit helloworld.asm`，
編輯完成後，接著執行下面指令來彙編檔案。
```
nasm -f elf64 helloworld.asm
ld helloworld.o -o helloworld
./helloworld
```
即會輸出編輯檔案中撰寫的輸出`hello World!`

接下來，做binary簡單分析。
```
> file helloworld
> strings helloworld
```
同理，編譯成32位元，下面hexdump看看。
```
> hexdump helloworld2
```
Output:
```
0000000 457f 464c 0101 0001 0000 0000 0000 0000
0000010 0002 0003 0001 0000 9000 0804 0034 0000
0000020 212c 0000 0000 0000 0034 0020 0004 0028
0000030 0007 0006 0001 0000 0000 0000 8000 0804
0000040 8000 0804 00d0 0000 00d0 0000 0004 0000
0000050 1000 0000 0001 0000 1000 0000 9000 0804
0000060 9000 0804 001d 0000 001d 0000 0005 0000
0000070 1000 0000 0001 0000 2000 0000 a000 0804
0000080 a000 0804 000d 0000 000d 0000 0006 0000
0000090 1000 0000 0004 0000 00b4 0000 80b4 0804
00000a0 80b4 0804 001c 0000 001c 0000 0004 0000
00000b0 0004 0000 0004 0000 000c 0000 0005 0000
00000c0 4e47 0055 0001 c000 0004 0000 0001 0000
00000d0 0000 0000 0000 0000 0000 0000 0000 0000
*
0001000 0dba 0000 b900 a000 0804 01bb 0000 b800
0001010 0004 0000 80cd 01b8 0000 cd00 0080 0000
0001020 0000 0000 0000 0000 0000 0000 0000 0000
*
0002000 6568 6c6c 206f 6f57 6c72 2164 000a 0000
0002010 0000 0000 0000 0000 0000 0000 0000 0000
0002020 0000 0000 80b4 0804 0000 0000 0003 0001
0002030 0000 0000 9000 0804 0000 0000 0003 0002
0002040 0000 0000 a000 0804 0000 0000 0003 0003
0002050 0001 0000 0000 0000 0000 0000 0004 fff1
0002060 0010 0000 a000 0804 0000 0000 0000 0003
0002070 0014 0000 000d 0000 0000 0000 0000 fff1
0002080 001d 0000 9000 0804 0000 0000 0010 0002
0002090 0018 0000 a00d 0804 0000 0000 0010 0003
00020a0 0024 0000 a00d 0804 0000 0000 0010 0003
00020b0 002b 0000 a010 0804 0000 0000 0010 0003
00020c0 6800 6c65 6f6c 6f77 6c72 2e64 7361 006d
00020d0 736d 0067 656c 006e 5f5f 7362 5f73 7473
00020e0 7261 0074 655f 6164 6174 5f00 6e65 0064
00020f0 2e00 7973 746d 6261 2e00 7473 7472 6261
0002100 2e00 6873 7473 7472 6261 2e00 6f6e 6574
0002110 672e 756e 702e 6f72 6570 7472 0079 742e
0002120 7865 0074 642e 7461 0061 0000 0000 0000
0002130 0000 0000 0000 0000 0000 0000 0000 0000
*
0002150 0000 0000 001b 0000 0007 0000 0002 0000
0002160 80b4 0804 00b4 0000 001c 0000 0000 0000
0002170 0000 0000 0004 0000 0000 0000 002e 0000
0002180 0001 0000 0006 0000 9000 0804 1000 0000
0002190 001d 0000 0000 0000 0000 0000 0010 0000
00021a0 0000 0000 0034 0000 0001 0000 0003 0000
00021b0 a000 0804 2000 0000 000d 0000 0000 0000
00021c0 0000 0000 0004 0000 0000 0000 0001 0000
00021d0 0002 0000 0000 0000 0000 0000 2010 0000
00021e0 00b0 0000 0005 0000 0007 0000 0004 0000
00021f0 0010 0000 0009 0000 0003 0000 0000 0000
0002200 0000 0000 20c0 0000 0030 0000 0000 0000
0002210 0000 0000 0001 0000 0000 0000 0011 0000
0002220 0003 0000 0000 0000 0000 0000 20f0 0000
0002230 003a 0000 0000 0000 0000 0000 0001 0000
0002240 0000 0000                              
0002244
```
